# 五大文件重构方案

## 总览
- **重构目标**: 将大文件拆分成不超过500行的小组件
- **重构原则**: 单一职责、高内聚低耦合、易于测试和维护
- **重构范围**: 5个文件，总计10000+行代码

## 1. AI Analyzer (2122行) → 5个组件

### 1.1 ai_analyzer_core.py (≤500行)
**职责**: 核心AI分析服务和配置管理
```python
class AIAnalyzerService:
    def __init__(self)
    def is_available(self)
    def analyze_text_async(self)
    def _build_system_prompt(self)
    def _validate_response_authenticity(self)
```

### 1.2 ai_prompt_builder.py (≤500行)
**职责**: 提示词构建和模板管理
```python
class PromptBuilder:
    def _build_enhanced_system_prompt(self)
    def _build_user_prompt(self)
    def _build_step2_context(self)
    def _build_step3_context(self)
    def _build_step4_context(self)
    def _build_step5_context(self)
```

### 1.3 ai_image_processor.py (≤500行)
**职责**: 图像预处理和编码
```python
class AIImageProcessor:
    def _prepare_images(self)
    def generate_qto_from_local_images(self)
    def generate_qto_from_encoded_images(self)
```

### 1.4 ai_multi_turn_analyzer.py (≤500行)
**职责**: 多轮对话分析（废弃的五步方法）
```python
class MultiTurnAnalyzer:
    def _execute_multi_turn_analysis(self)
    def _execute_contextual_step_1(self) to _execute_contextual_step_5(self)
    def _make_contextual_api_call(self)
```

### 1.5 ai_result_synthesizer.py (≤500行)
**职责**: 结果合成和QTO数据构建
```python
class ResultSynthesizer:
    def _synthesize_qto_data(self)
    def _determine_component_type(self)
    def _generate_quantity_summary(self)
    def _check_for_mock_data_patterns(self)
```

## 2. DWG Processor Legacy (3330行) → 7个组件

### 2.1 dwg_processor_core.py (≤500行)
**职责**: DWG处理器核心类和初始化
```python
class DWGProcessor:
    def __init__(self)
    def _setup_chinese_fonts(self)
    def _check_oda_converter(self)
    def safe_filename(self)
```

### 2.2 dwg_file_converter.py (≤500行)
**职责**: DWG文件转换和验证
```python
class DWGFileConverter:
    def _convert_dwg_with_oda(self)
    def _manual_convert_dwg_to_dxf(self)
    def _validate_dxf_file(self)
    def _quick_validate_dxf(self)
```

### 2.3 dwg_frame_detector.py (≤500行)
**职责**: 图框检测和识别
```python
class FrameDetector:
    def _detect_title_blocks_and_frames(self)
    def _find_standard_frames(self)
    def _find_frames_relaxed(self)
    def _supplementary_frame_detection(self)
```

### 2.4 dwg_frame_validator.py (≤500行)
**职责**: 图框验证和评分
```python
class FrameValidator:
    def _validate_frame_by_standard(self)
    def _validate_title_block_standard(self)
    def _validate_border_integrity(self)
    def _validate_standard_texts(self)
```

### 2.5 dwg_component_extractor.py (≤500行)
**职责**: 构件提取和分类
```python
class ComponentExtractor:
    def _extract_components_from_frame(self)
    def _classify_entity_as_component(self)
    def _generate_demo_components(self)
    def _calculate_quantities(self)
```

### 2.6 dwg_image_generator.py (≤500行)
**职责**: 图像生成和可视化
```python
class ImageGenerator:
    def _generate_frame_image(self)
    def _plot_entity(self)
    def _export_frame_to_pdf(self)
    def _export_layout_to_pdf(self)
```

### 2.7 dwg_multiprocess_handler.py (≤500行)
**职责**: 多进程处理和任务管理
```python
def process_frame_mp(args)
def _setup_matplotlib_chinese_fonts()
class MultiProcessHandler:
    def process_multi_sheets(self)
    def _fallback_single_process(self)
```

## 3. Enhanced Grid Slice Analyzer (2136行) → 5个组件

### 3.1 grid_slice_analyzer_core.py (≤500行)
**职责**: 核心分析器和初始化
```python
class EnhancedGridSliceAnalyzer:
    def __init__(self)
    def reset_batch_state(self)
    def analyze_drawing_with_dual_track(self)
    def _initialize_coordinate_service(self)
```

### 3.2 grid_slice_ocr_processor.py (≤500行)
**职责**: OCR处理和缓存管理
```python
class OCRProcessor:
    def _extract_ocr_from_slices_optimized(self)
    def _can_reuse_slice_ocr(self)
    def _load_cached_ocr_results(self)
    def _cache_slice_ocr_results(self)
```

### 3.3 grid_slice_vision_analyzer.py (≤500行)
**职责**: Vision分析和图像处理
```python
class VisionAnalyzer:
    def _analyze_slices_with_enhanced_vision(self)
    def _analyze_single_slice_with_vision(self)
    def _generate_enhanced_prompt(self)
    def _parse_vision_components(self)
```

### 3.4 grid_slice_coordinate_manager.py (≤500行)
**职责**: 坐标管理和变换
```python
class CoordinateManager:
    def _restore_global_coordinates_optimized(self)
    def _reuse_shared_slices(self)
    def _load_shared_ocr_results(self)
```

### 3.5 grid_slice_result_merger.py (≤500行)
**职责**: 结果合并和工程量计算
```python
class ResultMerger:
    def _merge_dual_track_results(self)
    def _generate_quantity_list_display(self)
    def _calculate_area(self)
    def _calculate_volume(self)
```

## 4. Vision Scanner (1103行) → 3个组件

### 4.1 vision_scanner_core.py (≤500行)
**职责**: 核心扫描服务
```python
class VisionScannerService:
    def __init__(self)
    def scan_images_and_store(self)
    def scan_images_with_shared_slices(self)
```

### 4.2 vision_batch_processor.py (≤500行)
**职责**: 批次处理和任务管理
```python
class VisionBatchProcessor:
    def _process_slices_in_batches(self)
    def _merge_batch_results(self)
    def _safe_convert_to_number(self)
```

### 4.3 vision_result_coordinator.py (≤500行)
**职责**: 结果协调和存储
```python
class VisionResultCoordinator:
    def _restore_coordinates_and_merge_components(self)
    def _merge_duplicate_components(self)
    def _save_merged_vision_result(self)
```

## 5. Drawing Tasks (1348行) → 3个组件

### 5.1 drawing_tasks_core.py (≤500行)
**职责**: 核心任务类和主流程
```python
class CallbackTask(Task)
@celery_app.task process_drawing_celery_task()
@celery_app.task batch_process_drawings_celery_task()
```

### 5.2 drawing_image_processor.py (≤500行)
**职责**: 图像处理和OCR集成
```python
async def process_images_with_shared_slices()
async def process_images_with_enhanced_ocr()
def remove_duplicate_regions()
def calculate_average_confidence()
```

### 5.3 drawing_result_manager.py (≤500行)
**职责**: 结果管理和存储
```python
def _save_merged_paddleocr_result()
# 结果保存和S3同步相关函数
```

## 实施计划

### 第一阶段：基础重构 (优先级：高)
1. AI Analyzer → ai_analyzer_core.py + ai_prompt_builder.py
2. Vision Scanner → vision_scanner_core.py + vision_batch_processor.py

### 第二阶段：核心重构 (优先级：中)
3. Enhanced Grid Slice Analyzer → 5个组件
4. Drawing Tasks → 3个组件

### 第三阶段：遗留重构 (优先级：低)
5. DWG Processor Legacy → 7个组件 (因为已废弃，优先级最低)

## 重构原则

### 依赖注入
- 各组件间通过依赖注入解耦
- 便于单元测试和模块替换

### 配置统一
- 所有配置统一从 `app.core.config` 读取
- 环境变量支持

### 日志统一
- 使用统一的日志格式
- 支持结构化日志

### 错误处理
- 统一的异常处理机制
- 优雅降级策略

## 预期收益

1. **可维护性提升**: 单个文件不超过500行，易于理解和修改
2. **测试覆盖度提升**: 小组件易于编写单元测试
3. **开发效率提升**: 减少文件冲突，支持并行开发
4. **系统稳定性提升**: 模块化设计降低系统耦合度 