# 🚀 智能工程量计算系统 - 新架构启动指南

## 📋 系统要求

- Python 3.8+
- Redis服务器
- Windows 10/11 (测试环境)

## 🔧 快速启动

### 方法一：使用启动脚本 (推荐)

```bash
# 1. 进入后端目录
cd backend

# 2. 安装依赖
pip install -r requirements.txt

# 3. 启动Redis (如果没有运行)
# Windows: 下载并启动 Redis for Windows
# 或使用 Docker: docker run -d -p 6379:6379 redis

# 4. 运行启动脚本 (自动完成所有初始化)
python start_system.py
```

### 方法二：手动分步启动

```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 启动Redis
redis-server

# 3. 初始化数据库 (如果是首次运行)
python -c "
from app.database import engine, Base
from app.models.user import User
from app.core.security import get_password_hash
from app.database import SessionLocal

# 创建表
Base.metadata.create_all(bind=engine)

# 创建测试用户
db = SessionLocal()
if not db.query(User).filter(User.username == 'testuser').first():
    test_user = User(
        username='testuser',
        email='test@example.com',
        full_name='测试用户',
        hashed_password=get_password_hash('testpass123'),
        is_active=True
    )
    db.add(test_user)
    db.commit()
    print('测试用户创建成功')
db.close()
"

# 4. 启动Celery Worker (新窗口)
celery -A app.core.celery_app worker --loglevel=info --pool=solo

# 5. 启动FastAPI (新窗口)
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

## 🧪 运行测试

```bash
# 确保系统已启动后运行
python test_new_architecture.py
```

## 📊 测试流程

新架构测试包含以下步骤：

1. **用户认证** - 测试登录功能
2. **S3文件上传** - 测试云存储集成
3. **Celery任务处理** - 测试异步任务处理
4. **工程量计算** - 测试AI识别和计算
5. **导出功能** - 测试Excel导出
6. **数据一致性** - 验证数据完整性

## 🔄 完整数据流程

```
📤 文件上传 → S3云存储 → 数据库记录 → Celery任务触发
    ↓
🔄 文件格式转换 (PDF→PNG, DWG→图像/文本)
    ↓
🤖 智能识别 (PaddleOCR + 大模型二阶段分析)
    ↓
🧮 工程量计算 (构件分类 + 尺寸提取 + 公式计算)
    ↓
💾 数据存储 (JSON结构化存储)
    ↓
📊 结果导出 (Excel多工作表)
```

## 🌐 系统服务

启动完成后可以访问：

- **FastAPI文档**: http://localhost:8000/docs
- **主页**: http://localhost:8000
- **API基础路径**: http://localhost:8000/api/v1

## 👤 测试账户

- **用户名**: testuser
- **密码**: testpass123
- **邮箱**: test@example.com

## 📁 主要模块

### 核心服务
- `s3_service.py` - S3云存储服务
- `file_processor.py` - 文件处理器 (PDF/DWG/图片)
- `quantity_calculator.py` - 工程量计算器
- `export_service.py` - Excel导出服务

### API接口
- `upload.py` - 文件上传API (支持S3)
- `export.py` - 导出功能API
- `drawing_tasks.py` - Celery异步任务

### 数据模型
- 新增字段：`s3_key`, `s3_url`, `s3_bucket`
- 结果字段：`quantity_results`, `recognition_results`

## 🔧 配置说明

### 环境变量 (.env文件)
```env
# AWS S3配置 (测试环境使用默认值)
AWS_ACCESS_KEY_ID=test_access_key
AWS_SECRET_ACCESS_KEY=test_secret_key
AWS_REGION=us-east-1
S3_BUCKET_NAME=smart-qto-bucket

# Redis配置
REDIS_URL=redis://localhost:6379/1

# OpenAI配置 (可选)
OPENAI_API_KEY=your_openai_key
```

## 🚨 常见问题

### Redis连接失败
```bash
# Windows安装Redis
# 1. 下载 Redis for Windows
# 2. 或使用 Docker: docker run -d -p 6379:6379 redis
```

### Celery启动失败
```bash
# Windows推荐使用solo池
celery -A app.core.celery_app worker --pool=solo --loglevel=info
```

### S3服务初始化失败
```bash
# 测试环境使用模拟S3，确保配置正确
# 生产环境需要真实的AWS凭证
```

## ✅ 启动成功标志

看到以下输出表示系统启动成功：

```
🎉 系统启动完成！
📊 FastAPI文档: http://localhost:8000/docs
🔍 Redis连接: localhost:6379
👤 测试用户: testuser / testpass123
💡 现在可以运行测试: python test_new_architecture.py
```

## 🧪 运行完整测试

```bash
python test_new_architecture.py
```

预期输出：
```
🚀 智能工程量计算系统 - 新架构测试
测试数据流程：文件上传 → S3存储 → Celery处理 → 工程量计算 → 导出
✅ 用户认证成功
✅ 文件上传成功
✅ Celery任务处理完成
✅ 导出预览成功
✅ Excel导出成功
🎉 所有测试通过！新架构运行正常
```

## 📚 架构优势

1. **统一Celery架构** - 移除FastAPI BackgroundTasks，统一异步处理
2. **S3云存储集成** - 可扩展的文件存储解决方案
3. **智能处理流水线** - 多格式支持 + AI多模态识别
4. **专业工程量计算** - 符合规范的Excel表格导出
5. **完善的测试覆盖** - 端到端流程验证

---

🎉 **准备好体验新架构了吗？运行 `python start_system.py` 开始吧！**