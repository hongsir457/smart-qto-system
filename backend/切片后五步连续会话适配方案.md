# åˆ‡ç‰‡åäº”æ­¥è¿ç»­ä¼šè¯é€‚é…æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜åˆ†æ

ç”¨æˆ·æå‡ºäº†ä¸€ä¸ªé‡è¦é—®é¢˜ï¼š
> "åˆ‡ç‰‡åæ˜¯ä¸æ˜¯è¿˜é€‚åˆå’Œå¤§æ¨¡å‹äº”æ­¥è¿ç»­ä¼šè¯ã€‚å¯¹äºå±€éƒ¨åˆ‡ç‰‡éœ€è¦é‡æ–°è®¾ç½®è¿ç»­ä¼šè¯çš„å†…å®¹"

## ğŸ” ç°çŠ¶åˆ†æ

### 1. å½“å‰äº”æ­¥äº¤äº’æµç¨‹
ç°æœ‰çš„äº”æ­¥äº¤äº’ï¼ˆStep 1-5ï¼‰æ˜¯åŸºäº**å®Œæ•´å›¾çº¸**è®¾è®¡çš„ï¼š

```
Step 1: é¡¹ç›®ä¸å›¾çº¸åŸºæœ¬ä¿¡æ¯è¯†åˆ«
Step 2: æ„ä»¶ç¼–å·æ¸…å•æå–  
Step 3: æ„ä»¶æ•°é‡ç»Ÿè®¡
Step 4: æ„ä»¶å®šä½ä¿¡æ¯
Step 5: æ„ä»¶è¯¦ç»†å±æ€§
```

### 2. åˆ‡ç‰‡å¤„ç†åçš„æŒ‘æˆ˜

**é—®é¢˜1ï¼šä¸Šä¸‹æ–‡ä¸¢å¤±**
- æ¯ä¸ªåˆ‡ç‰‡åªåŒ…å«å±€éƒ¨ä¿¡æ¯
- ç¼ºä¹å…¨å›¾çš„æ•´ä½“ä¸Šä¸‹æ–‡
- æ„ä»¶é—´çš„å…³è”å…³ç³»ä¸¢å¤±

**é—®é¢˜2ï¼šæ­¥éª¤é€‚é…æ€§å·®**
- Step 1ï¼ˆé¡¹ç›®ä¿¡æ¯ï¼‰ï¼šå¯èƒ½åœ¨æ¯ä¸ªåˆ‡ç‰‡ä¸­é‡å¤æˆ–ç¼ºå¤±
- Step 2ï¼ˆæ„ä»¶æ¸…å•ï¼‰ï¼šæ¯ä¸ªåˆ‡ç‰‡åªèƒ½çœ‹åˆ°å±€éƒ¨æ„ä»¶
- Step 3ï¼ˆæ•°é‡ç»Ÿè®¡ï¼‰ï¼šæ— æ³•å‡†ç¡®ç»Ÿè®¡å…¨å›¾æ•°é‡
- Step 4ï¼ˆå®šä½ä¿¡æ¯ï¼‰ï¼šåæ ‡ç³»ç»Ÿéœ€è¦é‡æ–°æ˜ å°„
- Step 5ï¼ˆè¯¦ç»†å±æ€§ï¼‰ï¼šå±æ€§æå–ç›¸å¯¹ç‹¬ç«‹ï¼Œé€‚é…æ€§è¾ƒå¥½

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šåˆ†å±‚äº”æ­¥äº¤äº’ï¼ˆæ¨èï¼‰

#### ç¬¬ä¸€å±‚ï¼šå…¨å›¾æ¦‚è§ˆåˆ†æ
ä½¿ç”¨**åŸå›¾ç¼©ç•¥å›¾**è¿›è¡Œå…¨å±€äº”æ­¥äº¤äº’ï¼š

```python
# å…¨å›¾æ¦‚è§ˆäº”æ­¥äº¤äº’
def global_five_step_analysis(original_image_thumbnail):
    """
    åŸºäºåŸå›¾ç¼©ç•¥å›¾çš„å…¨å±€åˆ†æ
    ç›®æ ‡ï¼šè·å–æ•´ä½“é¡¹ç›®ä¿¡æ¯å’Œæ„ä»¶å¸ƒå±€
    """
    step1_global = extract_project_info(original_image_thumbnail)
    step2_global = extract_component_overview(original_image_thumbnail)  
    step3_global = estimate_component_counts(original_image_thumbnail)
    step4_global = identify_overall_layout(original_image_thumbnail)
    step5_global = extract_general_specifications(original_image_thumbnail)
    
    return {
        'global_context': {
            'project_info': step1_global,
            'component_overview': step2_global,
            'layout_framework': step4_global
        },
        'global_estimates': step3_global,
        'general_specs': step5_global
    }
```

#### ç¬¬äºŒå±‚ï¼šåˆ‡ç‰‡è¯¦ç»†åˆ†æ
åŸºäºå…¨å±€ä¸Šä¸‹æ–‡ï¼Œå¯¹æ¯ä¸ªåˆ‡ç‰‡è¿›è¡Œ**è‡ªé€‚åº”ä¸‰æ­¥äº¤äº’**ï¼š

```python
# åˆ‡ç‰‡è¯¦ç»†åˆ†æï¼ˆç®€åŒ–ä¸‰æ­¥ï¼‰
def slice_detail_analysis(slice_image, global_context, slice_position):
    """
    åŸºäºå…¨å±€ä¸Šä¸‹æ–‡çš„åˆ‡ç‰‡è¯¦ç»†åˆ†æ
    ç›®æ ‡ï¼šæå–åˆ‡ç‰‡å†…çš„è¯¦ç»†æ„ä»¶ä¿¡æ¯
    """
    # æ³¨å…¥å…¨å±€ä¸Šä¸‹æ–‡
    context_prompt = f"""
    å…¨å›¾é¡¹ç›®ä¿¡æ¯ï¼š{global_context['project_info']}
    æ•´ä½“æ„ä»¶æ¦‚è§ˆï¼š{global_context['component_overview']}
    å½“å‰åˆ‡ç‰‡ä½ç½®ï¼š{slice_position}
    
    è¯·åŸºäºä»¥ä¸Šä¸Šä¸‹æ–‡åˆ†æå½“å‰åˆ‡ç‰‡ï¼š
    """
    
    # ç®€åŒ–ä¸‰æ­¥äº¤äº’
    step1_slice = identify_local_components(slice_image, context_prompt)
    step2_slice = extract_detailed_dimensions(slice_image, step1_slice)
    step3_slice = extract_reinforcement_details(slice_image, step1_slice)
    
    return {
        'local_components': step1_slice,
        'detailed_dimensions': step2_slice,
        'reinforcement_info': step3_slice,
        'slice_metadata': {
            'position': slice_position,
            'global_context_used': True
        }
    }
```

### æ–¹æ¡ˆBï¼šä¸Šä¸‹æ–‡é“¾ä¼ é€’ï¼ˆå¤‡é€‰ï¼‰

ä¸ºæ¯ä¸ªåˆ‡ç‰‡æ„å»º**ç´¯ç§¯ä¸Šä¸‹æ–‡é“¾**ï¼š

```python
def context_chain_analysis(slices, initial_context=None):
    """
    ä¸Šä¸‹æ–‡é“¾å¼åˆ†æ
    æ¯ä¸ªåˆ‡ç‰‡çš„åˆ†æç»“æœä¼šä¼ é€’ç»™ä¸‹ä¸€ä¸ªåˆ‡ç‰‡
    """
    context_chain = initial_context or {}
    slice_results = []
    
    for i, slice_info in enumerate(slices):
        # æ„å»ºå½“å‰åˆ‡ç‰‡çš„ä¸Šä¸‹æ–‡
        current_context = {
            'previous_components': context_chain.get('components', []),
            'accumulated_project_info': context_chain.get('project_info', {}),
            'slice_sequence': i + 1,
            'total_slices': len(slices)
        }
        
        # æ‰§è¡Œè‡ªé€‚åº”åˆ†æ
        slice_result = adaptive_slice_analysis(
            slice_info['image'], 
            current_context,
            slice_info['position']
        )
        
        # æ›´æ–°ä¸Šä¸‹æ–‡é“¾
        context_chain = update_context_chain(context_chain, slice_result)
        slice_results.append(slice_result)
    
    return slice_results, context_chain
```

## ğŸ¯ å…·ä½“å®ç°ç­–ç•¥

### 1. ä¸Šä¸‹æ–‡æ³¨å…¥æœºåˆ¶

```python
class SliceContextManager:
    """åˆ‡ç‰‡ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""
    
    def __init__(self, global_analysis_result):
        self.global_context = global_analysis_result
        self.slice_contexts = {}
    
    def generate_slice_prompt(self, slice_index, slice_position):
        """ä¸ºç‰¹å®šåˆ‡ç‰‡ç”Ÿæˆå¸¦ä¸Šä¸‹æ–‡çš„æç¤ºè¯"""
        
        base_context = f"""
        ã€å…¨å›¾é¡¹ç›®ä¿¡æ¯ã€‘
        é¡¹ç›®åç§°ï¼š{self.global_context.get('project_name', 'æœªçŸ¥')}
        å›¾çº¸ç±»å‹ï¼š{self.global_context.get('drawing_type', 'ç»“æ„å›¾')}
        æ¯”ä¾‹å°ºï¼š{self.global_context.get('scale', 'æœªçŸ¥')}
        
        ã€æ•´ä½“æ„ä»¶å¸ƒå±€ã€‘
        ä¸»è¦æ„ä»¶ç±»å‹ï¼š{', '.join(self.global_context.get('main_component_types', []))}
        é¢„ä¼°æ„ä»¶æ€»æ•°ï¼š{self.global_context.get('estimated_total', 'æœªçŸ¥')}
        
        ã€å½“å‰åˆ‡ç‰‡ä¿¡æ¯ã€‘
        åˆ‡ç‰‡ä½ç½®ï¼š{slice_position}
        åˆ‡ç‰‡åºå·ï¼š{slice_index + 1}
        
        ã€åˆ†æè¦æ±‚ã€‘
        è¯·åŸºäºä»¥ä¸Šå…¨å›¾ä¸Šä¸‹æ–‡ï¼Œé‡ç‚¹åˆ†æå½“å‰åˆ‡ç‰‡ä¸­çš„ï¼š
        1. å…·ä½“æ„ä»¶è¯¦æƒ…ï¼ˆç¼–å·ã€å°ºå¯¸ã€é…ç­‹ï¼‰
        2. æ„ä»¶ä¸å‘¨è¾¹çš„è¿æ¥å…³ç³»
        3. ç‰¹æ®Šæ ‡æ³¨å’Œè¯¦å›¾ä¿¡æ¯
        
        æ³¨æ„ï¼š
        - ä¿æŒä¸å…¨å›¾é¡¹ç›®ä¿¡æ¯çš„ä¸€è‡´æ€§
        - æ„ä»¶ç¼–å·åº”ç¬¦åˆæ•´ä½“ç¼–å·è§„å¾‹
        - å°ºå¯¸å•ä½åº”ä¸å›¾çº¸æ¯”ä¾‹å°ºåŒ¹é…
        """
        
        return base_context
```

### 2. è‡ªé€‚åº”æ­¥éª¤é€‰æ‹©

```python
def adaptive_step_selection(slice_characteristics):
    """
    æ ¹æ®åˆ‡ç‰‡ç‰¹å¾è‡ªé€‚åº”é€‰æ‹©åˆ†ææ­¥éª¤
    """
    steps = []
    
    # åŸºç¡€æ­¥éª¤ï¼šæ„ä»¶è¯†åˆ«ï¼ˆå¿…é€‰ï¼‰
    steps.append('component_identification')
    
    # æ¡ä»¶æ­¥éª¤
    if slice_characteristics.get('has_dimensions'):
        steps.append('dimension_extraction')
    
    if slice_characteristics.get('has_reinforcement'):
        steps.append('reinforcement_analysis')
    
    if slice_characteristics.get('has_details'):
        steps.append('detail_analysis')
    
    if slice_characteristics.get('has_connections'):
        steps.append('connection_analysis')
    
    return steps
```

### 3. ç»“æœä¸€è‡´æ€§æ ¡éªŒ

```python
def validate_slice_consistency(slice_results, global_context):
    """
    æ ¡éªŒåˆ‡ç‰‡ç»“æœä¸å…¨å±€ä¸Šä¸‹æ–‡çš„ä¸€è‡´æ€§
    """
    inconsistencies = []
    
    for slice_result in slice_results:
        # æ£€æŸ¥é¡¹ç›®ä¿¡æ¯ä¸€è‡´æ€§
        if slice_result.get('project_name') != global_context.get('project_name'):
            inconsistencies.append({
                'type': 'project_name_mismatch',
                'slice_value': slice_result.get('project_name'),
                'global_value': global_context.get('project_name')
            })
        
        # æ£€æŸ¥æ„ä»¶ç¼–å·è§„å¾‹
        component_ids = [c.get('id') for c in slice_result.get('components', [])]
        if not validate_component_id_pattern(component_ids, global_context):
            inconsistencies.append({
                'type': 'component_id_pattern_mismatch',
                'slice_ids': component_ids
            })
    
    return inconsistencies
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æ–¹æ¡ˆ | APIè°ƒç”¨æ¬¡æ•° | åˆ†æç²¾åº¦ | ä¸Šä¸‹æ–‡å®Œæ•´æ€§ | å®ç°å¤æ‚åº¦ |
|------|------------|----------|-------------|-----------|
| åŸå§‹äº”æ­¥äº¤äº’ | 5Ã—åˆ‡ç‰‡æ•° | ä¸­ç­‰ | å·® | ä½ |
| åˆ†å±‚äº”æ­¥äº¤äº’ | 5 + 3Ã—åˆ‡ç‰‡æ•° | é«˜ | å¥½ | ä¸­ç­‰ |
| ä¸Šä¸‹æ–‡é“¾ä¼ é€’ | åŠ¨æ€ | ä¸­é«˜ | ä¸­ç­‰ | é«˜ |

## ğŸš€ æ¨èå®æ–½è·¯å¾„

### Phase 1ï¼šå…¨å›¾æ¦‚è§ˆå¢å¼º
1. åœ¨åˆ‡ç‰‡å¤„ç†å‰ï¼Œæ·»åŠ å…¨å›¾ç¼©ç•¥å›¾åˆ†æ
2. æå–å…³é”®çš„é¡¹ç›®ä¿¡æ¯å’Œå¸ƒå±€æ¡†æ¶
3. å»ºç«‹å…¨å±€æ„ä»¶è¯å…¸

### Phase 2ï¼šåˆ‡ç‰‡ä¸Šä¸‹æ–‡æ³¨å…¥
1. ä¸ºæ¯ä¸ªåˆ‡ç‰‡æ³¨å…¥å…¨å±€ä¸Šä¸‹æ–‡
2. å®æ–½è‡ªé€‚åº”ä¸‰æ­¥åˆ†æ
3. æ·»åŠ ç»“æœä¸€è‡´æ€§æ ¡éªŒ

### Phase 3ï¼šæ™ºèƒ½åˆå¹¶ä¼˜åŒ–
1. åŸºäºä¸Šä¸‹æ–‡çš„æ™ºèƒ½å»é‡
2. æ„ä»¶å…³è”å…³ç³»æ¨ç†
3. è‡ªåŠ¨è´¨é‡è¯„ä¼°å’Œä¿®æ­£

## ğŸ”§ é›†æˆåˆ°ç°æœ‰ç³»ç»Ÿ

```python
# åœ¨ VisionScannerService ä¸­æ·»åŠ 
class VisionScannerService:
    
    def scan_images_with_contextual_slices(self, 
                                         image_paths: List[str],
                                         shared_slice_results: Dict[str, Any], 
                                         drawing_id: int,
                                         task_id: str = None) -> Dict[str, Any]:
        """
        åŸºäºä¸Šä¸‹æ–‡çš„åˆ‡ç‰‡Visionåˆ†æ
        """
        
        # Phase 1: å…¨å›¾æ¦‚è§ˆåˆ†æ
        global_context = self._analyze_global_overview(
            image_paths[0],  # ä½¿ç”¨ç¬¬ä¸€å¼ å›¾ä½œä¸ºä¸»å›¾
            task_id
        )
        
        # Phase 2: åˆ‡ç‰‡è¯¦ç»†åˆ†æ
        slice_results = []
        context_manager = SliceContextManager(global_context)
        
        for image_path, slice_info in shared_slice_results.items():
            if slice_info.get('sliced', False):
                slice_infos = slice_info.get('slice_infos', [])
                
                for i, slice_data in enumerate(slice_infos):
                    # ç”Ÿæˆä¸Šä¸‹æ–‡æç¤º
                    context_prompt = context_manager.generate_slice_prompt(
                        i, slice_data.get('position', (0, 0))
                    )
                    
                    # æ‰§è¡Œè‡ªé€‚åº”åˆ†æ
                    slice_result = self._analyze_slice_with_context(
                        slice_data, context_prompt, task_id, drawing_id
                    )
                    
                    slice_results.append(slice_result)
        
        # Phase 3: ç»“æœåˆå¹¶å’Œæ ¡éªŒ
        merged_result = self._merge_contextual_results(
            global_context, slice_results, task_id, drawing_id
        )
        
        return merged_result
```

## ğŸ“ æ€»ç»“

åˆ‡ç‰‡åçš„äº”æ­¥è¿ç»­ä¼šè¯ç¡®å®éœ€è¦é‡æ–°è®¾è®¡ï¼Œæ¨èé‡‡ç”¨**åˆ†å±‚äº”æ­¥äº¤äº’**æ–¹æ¡ˆï¼š

1. **å…¨å›¾æ¦‚è§ˆå±‚**ï¼šä¿æŒå®Œæ•´çš„äº”æ­¥äº¤äº’ï¼Œè·å–æ•´ä½“ä¸Šä¸‹æ–‡
2. **åˆ‡ç‰‡è¯¦ç»†å±‚**ï¼šç®€åŒ–ä¸ºä¸‰æ­¥äº¤äº’ï¼Œæ³¨å…¥å…¨å±€ä¸Šä¸‹æ–‡
3. **æ™ºèƒ½åˆå¹¶å±‚**ï¼šåŸºäºä¸Šä¸‹æ–‡çš„ç»“æœåˆå¹¶å’Œæ ¡éªŒ

è¿™æ ·æ—¢ä¿è¯äº†åˆ†æçš„å®Œæ•´æ€§ï¼Œåˆæé«˜äº†åˆ‡ç‰‡å¤„ç†çš„æ•ˆç‡å’Œå‡†ç¡®æ€§ã€‚ 