# æ™ºèƒ½å·¥ç¨‹é‡åˆ†æžç³»ç»Ÿ - æ ¸å¿ƒæ•°æ®ç»“æž„è®¾è®¡è¯´æ˜Ž

## ðŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜Žäº†æ™ºèƒ½å·¥ç¨‹é‡åˆ†æžç³»ç»Ÿçš„æ ¸å¿ƒæ•°æ®ç»“æž„è®¾è®¡ï¼Œå»ºç«‹äº†ç»Ÿä¸€çš„ä¸­é—´æ ¼å¼ï¼Œç¡®ä¿å„å¤„ç†æ­¥éª¤é—´çš„æ•°æ®ä¸€è‡´æ€§å’Œæµè½¬é¡ºç•…ã€‚

---

## ðŸŽ¯ è®¾è®¡åŽŸåˆ™

### 1. ç»Ÿä¸€æ€§åŽŸåˆ™
- æ‰€æœ‰å¤„ç†æ­¥éª¤ä½¿ç”¨ç›¸åŒçš„æ•°æ®ç»“æž„
- ç»Ÿä¸€çš„åºåˆ—åŒ–/ååºåˆ—åŒ–æŽ¥å£
- ä¸€è‡´çš„å‘½åè§„èŒƒå’Œå­—æ®µå®šä¹‰

### 2. å¯æ‰©å±•æ€§åŽŸåˆ™
- æ¨¡å—åŒ–çš„æ•°æ®ç»“æž„è®¾è®¡
- æ”¯æŒæ–°å¢žæž„ä»¶ç±»åž‹å’Œå±žæ€§
- é¢„ç•™æ‰©å±•å­—æ®µå’ŒæŽ¥å£

### 3. ç±»åž‹å®‰å…¨åŽŸåˆ™
- ä½¿ç”¨æžšä¸¾ç±»åž‹çº¦æŸå–å€¼èŒƒå›´
- å¼ºç±»åž‹å®šä¹‰ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- å®Œæ•´çš„æ•°æ®éªŒè¯æœºåˆ¶

### 4. æ€§èƒ½ä¼˜åŒ–åŽŸåˆ™
- é«˜æ•ˆçš„åºåˆ—åŒ–æ ¼å¼
- æœ€å°åŒ–æ•°æ®å†—ä½™
- æ”¯æŒå¢žé‡æ›´æ–°

---

## ðŸ—ï¸ æ•°æ®ç»“æž„å±‚æ¬¡

### ç¬¬ä¸€å±‚ï¼šåŸºç¡€ç±»åž‹
```
åŸºç¡€æžšä¸¾ (ComponentType, ProcessingStage, ConfidenceLevel, DataSource)
    â†“
å‡ ä½•ç±»åž‹ (Point2D, BoundingBox, Dimensions)
    â†“
æ–‡æœ¬ç±»åž‹ (OCRTextResult, SliceInfo)
```

### ç¬¬äºŒå±‚ï¼šæ ¸å¿ƒå®žä½“
```
æž„ä»¶æ ¸å¿ƒ (ComponentCore) - ç³»ç»Ÿçš„æ ¸å¿ƒæ•°æ®å®žä½“
    â†“
å¤„ç†ç»“æžœ (PreprocessingResult, OCRResult, OCRCleaningResult, etc.)
    â†“
å·¥ç¨‹é‡é¡¹ (QuantityItem, QuantityList)
```

### ç¬¬ä¸‰å±‚ï¼šèšåˆç»“æžœ
```
å®Œæ•´åˆ†æžç»“æžœ (AnalysisResult) - æ‰€æœ‰æ­¥éª¤çš„ç»Ÿä¸€è¾“å‡º
```

---

## ðŸ“Š æ•°æ®æµè½¬æž¶æž„

```
åŽŸå§‹å›¾çº¸ â†’ Step1:é¢„å¤„ç† â†’ PreprocessingResult
    â†“
Step2:OCRè¯†åˆ« â†’ OCRResult
    â†“
Step2.5:OCRæ¸…æ´— â†’ OCRCleaningResult
    â†“
Step3:å…¨å›¾æ¦‚è§ˆ â†˜
                â†’ Step5:ç»“æžœèžåˆ â†’ FusionResult
Step4:Visionåˆ†æž â†—
    â†“
Step6:åæ ‡è¿˜åŽŸ â†’ QuantityList
    â†“
AnalysisResult (å®Œæ•´èšåˆç»“æžœ)
```

---

## ðŸ”§ æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. ComponentCore - æž„ä»¶æ ¸å¿ƒæ•°æ®ç»“æž„

**è®¾è®¡ç›®æ ‡**: ç»Ÿä¸€æ‰€æœ‰æž„ä»¶ä¿¡æ¯çš„æ ‡å‡†æ ¼å¼

```python
@dataclass
class ComponentCore:
    # åŸºæœ¬æ ‡è¯†
    component_id: str                   # æž„ä»¶å”¯ä¸€ID
    component_type: ComponentType       # æž„ä»¶ç±»åž‹
    label: str = ""                     # æž„ä»¶æ ‡ç­¾/ç¼–å·
    
    # å‡ ä½•ä¿¡æ¯
    bbox: Optional[BoundingBox] = None  # è¾¹ç•Œæ¡†
    dimensions: Optional[Dimensions] = None # å°ºå¯¸ä¿¡æ¯
    
    # å±žæ€§ä¿¡æ¯
    material: str = ""                  # ææ–™ç±»åž‹
    grade: str = ""                     # å¼ºåº¦ç­‰çº§
    specification: str = ""             # è§„æ ¼æè¿°
    
    # ä½ç½®ä¿¡æ¯
    floor_level: str = ""               # æ¥¼å±‚
    axis_line: str = ""                 # è½´çº¿
    grid_position: str = ""             # ç½‘æ ¼ä½ç½®
    
    # æ•°æ®è´¨é‡
    confidence: float = 0.0             # æ•´ä½“ç½®ä¿¡åº¦
    confidence_level: ConfidenceLevel = ConfidenceLevel.LOW
    data_source: DataSource = DataSource.OCR
    
    # å¤„ç†ä¿¡æ¯
    created_at: datetime = field(default_factory=datetime.now)
    updated_at: datetime = field(default_factory=datetime.now)
    processing_stage: ProcessingStage = ProcessingStage.OCR_RECOGNITION
    
    # åŽŸå§‹æ•°æ®å¼•ç”¨
    source_texts: List[OCRTextResult] = field(default_factory=list)
    source_slices: List[str] = field(default_factory=list)
```

**å…³é”®ç‰¹æ€§**:
- ðŸ“Š **å®Œæ•´æ€§**: åŒ…å«æž„ä»¶çš„æ‰€æœ‰å…³é”®ä¿¡æ¯
- ðŸ”— **å¯è¿½æº¯æ€§**: ä¿ç•™åŽŸå§‹æ•°æ®å¼•ç”¨
- ðŸ“ˆ **è´¨é‡è¯„ä¼°**: å†…ç½®ç½®ä¿¡åº¦è¯„ä¼°æœºåˆ¶
- â±ï¸ **æ—¶é—´è¿½è¸ª**: è®°å½•åˆ›å»ºå’Œæ›´æ–°æ—¶é—´

### 2. BoundingBox - è¾¹ç•Œæ¡†æ•°æ®ç»“æž„

**è®¾è®¡ç›®æ ‡**: ç»Ÿä¸€ç©ºé—´ä½ç½®ä¿¡æ¯è¡¨ç¤º

```python
@dataclass
class BoundingBox:
    x_min: float
    y_min: float
    x_max: float
    y_max: float
    confidence: float = 1.0
    
    @property
    def width(self) -> float:
        return self.x_max - self.x_min
    
    @property
    def height(self) -> float:
        return self.y_max - self.y_min
    
    @property
    def center(self) -> Point2D:
        return Point2D(
            x=(self.x_min + self.x_max) / 2,
            y=(self.y_min + self.y_max) / 2
        )
```

**å…³é”®ç‰¹æ€§**:
- ðŸ“ **æ ‡å‡†åŒ–**: ç»Ÿä¸€çš„åæ ‡è¡¨ç¤ºæ–¹å¼
- ðŸ§® **è®¡ç®—å±žæ€§**: è‡ªåŠ¨è®¡ç®—å®½åº¦ã€é«˜åº¦ã€ä¸­å¿ƒç‚¹
- ðŸŽ¯ **ç½®ä¿¡åº¦**: ä½ç½®ä¿¡æ¯çš„å¯ä¿¡åº¦è¯„ä¼°

### 3. Dimensions - å°ºå¯¸ä¿¡æ¯æ•°æ®ç»“æž„

**è®¾è®¡ç›®æ ‡**: çµæ´»çš„æž„ä»¶å°ºå¯¸è¡¨ç¤º

```python
@dataclass
class Dimensions:
    length: Optional[float] = None      # é•¿åº¦(m)
    width: Optional[float] = None       # å®½åº¦(m)
    height: Optional[float] = None      # é«˜åº¦(m)
    thickness: Optional[float] = None   # åŽšåº¦(m)
    diameter: Optional[float] = None    # ç›´å¾„(m)
    area: Optional[float] = None        # é¢ç§¯(mÂ²)
    volume: Optional[float] = None      # ä½“ç§¯(mÂ³)
```

**å…³é”®ç‰¹æ€§**:
- ðŸ”§ **çµæ´»æ€§**: å¯é€‰å­—æ®µé€‚åº”ä¸åŒæž„ä»¶ç±»åž‹
- ðŸ“ **æ ‡å‡†å•ä½**: ç»Ÿä¸€ä½¿ç”¨ç±³åˆ¶å•ä½
- ðŸ§® **è®¡ç®—æ”¯æŒ**: æ”¯æŒé¢ç§¯ã€ä½“ç§¯ç­‰è®¡ç®—é‡

---

## ðŸ”„ æ•°æ®æµè½¬æœºåˆ¶

### 1. æ•°æ®åˆ›å»ºæµç¨‹

```python
# Step1: åˆ›å»ºåŸºç¡€å‡ ä½•ä¿¡æ¯
bbox = BoundingBox(x_min=100, y_min=200, x_max=150, y_max=600, confidence=0.9)
dimensions = Dimensions(length=0.4, width=0.4, height=3.0, volume=0.48)

# Step2: åˆ›å»ºæž„ä»¶æ ¸å¿ƒä¿¡æ¯
component = ComponentCore(
    component_id="C001",
    component_type=ComponentType.COLUMN,
    label="C1",
    bbox=bbox,
    dimensions=dimensions,
    material="C30æ··å‡åœŸ",
    confidence=0.85
)

# Step3: æ›´æ–°å¤„ç†é˜¶æ®µ
component.processing_stage = ProcessingStage.VISION_ANALYSIS
component.data_source = DataSource.VISION
```

### 2. æ•°æ®åºåˆ—åŒ–/ååºåˆ—åŒ–

```python
# åºåˆ—åŒ–ä¸ºå­—å…¸
component_dict = component.to_dict()

# åºåˆ—åŒ–ä¸ºJSON
import json
json_str = json.dumps(component_dict, ensure_ascii=False, indent=2)

# æŒä¹…åŒ–å­˜å‚¨
with open('component_data.json', 'w', encoding='utf-8') as f:
    f.write(json_str)
```

### 3. æ•°æ®éªŒè¯æœºåˆ¶

```python
# ä½¿ç”¨å†…ç½®éªŒè¯å™¨
errors = DataValidator.validate_component(component)
if errors:
    print("æ•°æ®éªŒè¯å¤±è´¥:", errors)
else:
    print("æ•°æ®éªŒè¯é€šè¿‡")
```

---

## ðŸ“ˆ è´¨é‡ç®¡ç†æœºåˆ¶

### 1. ç½®ä¿¡åº¦è¯„ä¼°

```python
class ConfidenceLevel(Enum):
    HIGH = "high"       # é«˜ç½®ä¿¡åº¦ (>0.8)
    MEDIUM = "medium"   # ä¸­ç­‰ç½®ä¿¡åº¦ (0.5-0.8)
    LOW = "low"         # ä½Žç½®ä¿¡åº¦ (<0.5)

# è‡ªåŠ¨æ›´æ–°ç½®ä¿¡åº¦ç­‰çº§
component.update_confidence_level()
```

### 2. æ•°æ®æ¥æºè¿½è¸ª

```python
class DataSource(Enum):
    OCR = "ocr"                    # OCRè¯†åˆ«
    VISION = "vision"              # Visionåˆ†æž
    FUSION = "fusion"              # èžåˆç»“æžœ
    MANUAL = "manual"              # äººå·¥æ ‡æ³¨

# è®°å½•æ•°æ®æ¥æº
component.data_source = DataSource.FUSION
```

### 3. å¤„ç†é˜¶æ®µç®¡ç†

```python
class ProcessingStage(Enum):
    PREPROCESSING = "preprocessing"     # Step1: é¢„å¤„ç†
    OCR_RECOGNITION = "ocr_recognition" # Step2: OCRè¯†åˆ«
    OCR_CLEANING = "ocr_cleaning"       # Step2.5: OCRæ¸…æ´—
    GLOBAL_OVERVIEW = "global_overview" # Step3: å…¨å›¾æ¦‚è§ˆ
    VISION_ANALYSIS = "vision_analysis" # Step4: Visionåˆ†æž
    RESULT_FUSION = "result_fusion"     # Step5: ç»“æžœèžåˆ
    COORDINATE_RESTORATION = "coordinate_restoration" # Step6: åæ ‡è¿˜åŽŸ

# æ›´æ–°å¤„ç†é˜¶æ®µ
component.processing_stage = ProcessingStage.RESULT_FUSION
```

---

## ðŸ”§ ä½¿ç”¨ç¤ºä¾‹

### 1. åˆ›å»ºå®Œæ•´çš„åˆ†æžç»“æžœ

```python
# åˆ›å»ºåˆ†æžç»“æžœå®¹å™¨
analysis_result = AnalysisResult(
    drawing_id="DWG_001",
    task_id="TASK_12345"
)

# æ·»åŠ é¢„å¤„ç†ç»“æžœ
analysis_result.preprocessing = PreprocessingResult(
    drawing_id="DWG_001",
    original_image_path="/path/to/image.pdf",
    slices=[slice1, slice2, slice3],
    frame_detected=True,
    processing_time=2.5
)

# æ·»åŠ OCRç»“æžœ
analysis_result.ocr_result = OCRResult(
    drawing_id="DWG_001",
    slice_results={"slice_1": [text1, text2], "slice_2": [text3]},
    processing_time=15.2
)

# è®¡ç®—æ•´ä½“è´¨é‡
analysis_result.calculate_overall_quality()

# åºåˆ—åŒ–å®Œæ•´ç»“æžœ
complete_data = analysis_result.to_dict()
```

### 2. æž„ä»¶æ•°æ®åˆå¹¶

```python
# OCRæž„ä»¶
ocr_component = ComponentCore(
    component_id="C001_OCR",
    component_type=ComponentType.COLUMN,
    label="C1",
    material="C30æ··å‡åœŸ",
    confidence=0.7,
    data_source=DataSource.OCR
)

# Visionæž„ä»¶
vision_component = ComponentCore(
    component_id="C001_VISION",
    component_type=ComponentType.COLUMN,
    bbox=BoundingBox(100, 200, 150, 600, 0.9),
    dimensions=Dimensions(length=0.4, width=0.4, height=3.0),
    confidence=0.85,
    data_source=DataSource.VISION
)

# èžåˆæž„ä»¶
fused_component = ComponentCore(
    component_id="C001",
    component_type=ComponentType.COLUMN,
    label="C1",
    bbox=vision_component.bbox,
    dimensions=vision_component.dimensions,
    material=ocr_component.material,
    confidence=(ocr_component.confidence + vision_component.confidence) / 2,
    data_source=DataSource.FUSION
)
```

### 3. å·¥ç¨‹é‡æ¸…å•ç”Ÿæˆ

```python
# åˆ›å»ºå·¥ç¨‹é‡æ¸…å•é¡¹
quantity_item = QuantityItem(
    item_id="Q001",
    component_id="C001",
    component_type=ComponentType.COLUMN,
    specification="400Ã—400Ã—3000 C30æ··å‡åœŸæŸ±",
    unit="mÂ³",
    quantity=0.48,
    unit_price=800.0,
    confidence=0.9,
    calculation_rule="é•¿Ã—å®½Ã—é«˜"
)

# åˆ›å»ºå·¥ç¨‹é‡æ¸…å•
quantity_list = QuantityList(
    drawing_id="DWG_001",
    project_info={"project_name": "æµ‹è¯•é¡¹ç›®", "drawing_number": "001"},
    quantity_items=[quantity_item]
)

# è®¡ç®—æ±‡æ€»ä¿¡æ¯
quantity_list.calculate_summary()
```

---

## ðŸš€ æœ€ä½³å®žè·µ

### 1. æ•°æ®åˆ›å»º
- âœ… å§‹ç»ˆä¸ºæž„ä»¶åˆ†é…å”¯ä¸€ID
- âœ… è®¾ç½®åˆé€‚çš„ç½®ä¿¡åº¦å€¼
- âœ… è®°å½•æ•°æ®æ¥æºå’Œå¤„ç†é˜¶æ®µ
- âœ… ä¿ç•™åŽŸå§‹æ•°æ®å¼•ç”¨

### 2. æ•°æ®æ›´æ–°
- âœ… æ›´æ–°æ—¶åŒæ­¥ä¿®æ”¹updated_atå­—æ®µ
- âœ… é‡æ–°è®¡ç®—ç½®ä¿¡åº¦ç­‰çº§
- âœ… ä¿æŒæ•°æ®ä¸€è‡´æ€§
- âœ… è®°å½•å˜æ›´åŽ†å²

### 3. æ•°æ®éªŒè¯
- âœ… ä½¿ç”¨å†…ç½®éªŒè¯å™¨æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
- âœ… éªŒè¯å‡ ä½•ä¿¡æ¯çš„åˆç†æ€§
- âœ… æ£€æŸ¥æžšä¸¾å€¼çš„æœ‰æ•ˆæ€§
- âœ… ç¡®ä¿å¿…å¡«å­—æ®µä¸ä¸ºç©º

### 4. æ€§èƒ½ä¼˜åŒ–
- âœ… ä½¿ç”¨æ‰¹é‡æ“ä½œå‡å°‘åºåˆ—åŒ–å¼€é”€
- âœ… åˆç†ä½¿ç”¨ç¼“å­˜æœºåˆ¶
- âœ… é¿å…ä¸å¿…è¦çš„æ·±æ‹·è´
- âœ… ä¼˜åŒ–å¤§æ•°æ®é›†çš„å¤„ç†

---

## ðŸ“‹ æ‰©å±•æŒ‡å—

### 1. æ–°å¢žæž„ä»¶ç±»åž‹

```python
# åœ¨ComponentTypeæžšä¸¾ä¸­æ·»åŠ æ–°ç±»åž‹
class ComponentType(Enum):
    # çŽ°æœ‰ç±»åž‹...
    EQUIPMENT = "equipment"     # è®¾å¤‡
    PIPE = "pipe"              # ç®¡é“
    CABLE = "cable"            # ç”µç¼†
```

### 2. æ–°å¢žå±žæ€§å­—æ®µ

```python
# åœ¨ComponentCoreä¸­æ·»åŠ æ–°å­—æ®µ
@dataclass
class ComponentCore:
    # çŽ°æœ‰å­—æ®µ...
    
    # æ–°å¢žå­—æ®µ
    installation_date: Optional[datetime] = None
    maintenance_info: Dict[str, Any] = field(default_factory=dict)
    custom_attributes: Dict[str, Any] = field(default_factory=dict)
```

### 3. æ–°å¢žå¤„ç†é˜¶æ®µ

```python
# åœ¨ProcessingStageæžšä¸¾ä¸­æ·»åŠ æ–°é˜¶æ®µ
class ProcessingStage(Enum):
    # çŽ°æœ‰é˜¶æ®µ...
    QUALITY_CHECK = "quality_check"         # è´¨é‡æ£€æŸ¥
    COST_ESTIMATION = "cost_estimation"     # æˆæœ¬ä¼°ç®—
    REPORT_GENERATION = "report_generation" # æŠ¥å‘Šç”Ÿæˆ
```

---

## ðŸŽ¯ æ€»ç»“

æœ¬æ ¸å¿ƒæ•°æ®ç»“æž„è®¾è®¡å®žçŽ°äº†ï¼š

1. **ç»Ÿä¸€æ€§**: æ‰€æœ‰å¤„ç†æ­¥éª¤ä½¿ç”¨ç›¸åŒçš„æ•°æ®æ ¼å¼
2. **å®Œæ•´æ€§**: æ¶µç›–æž„ä»¶è¯†åˆ«åˆ°å·¥ç¨‹é‡è®¡ç®—çš„å…¨æµç¨‹
3. **å¯æ‰©å±•æ€§**: æ”¯æŒæ–°å¢žæž„ä»¶ç±»åž‹å’Œå¤„ç†é˜¶æ®µ
4. **ç±»åž‹å®‰å…¨**: å¼ºç±»åž‹å®šä¹‰ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
5. **è´¨é‡ç®¡ç†**: å†…ç½®ç½®ä¿¡åº¦è¯„ä¼°å’Œæ•°æ®éªŒè¯æœºåˆ¶
6. **æ€§èƒ½ä¼˜åŒ–**: é«˜æ•ˆçš„åºåˆ—åŒ–å’Œæ•°æ®æµè½¬æœºåˆ¶

é€šè¿‡è¿™å¥—æ•°æ®ç»“æž„ï¼Œç³»ç»Ÿå„ç»„ä»¶å¯ä»¥æ— ç¼åä½œï¼Œç¡®ä¿æ•°æ®åœ¨æ•´ä¸ªå¤„ç†æµç¨‹ä¸­çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ã€‚ 