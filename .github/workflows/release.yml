name: ğŸš€ åˆ›å»ºReleaseç‰ˆæœ¬

on:
  push:
    tags:
      - 'v*.*.*'  # åŒ¹é… v1.0.0, v2.1.3 ç­‰ç‰ˆæœ¬æ ‡ç­¾

jobs:
  create-release:
    name: åˆ›å»ºGitHub Release
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

    - name: ğŸ“‹ è·å–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "version_without_v=${VERSION#v}" >> $GITHUB_OUTPUT

    - name: ğŸ“ æå–å˜æ›´æ—¥å¿—
      id: changelog
      run: |
        # ä»CHANGELOG.mdæå–å½“å‰ç‰ˆæœ¬çš„å˜æ›´å†…å®¹
        awk '/^## \['"${GITHUB_REF#refs/tags/v}"'\]/{flag=1; next} /^## \[/{flag=0} flag' CHANGELOG.md > current_changelog.md
        
        # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç‰¹å®šç‰ˆæœ¬çš„æ—¥å¿—ï¼Œä½¿ç”¨é»˜è®¤å†…å®¹
        if [ ! -s current_changelog.md ]; then
          echo "### ğŸ‰ ç‰ˆæœ¬å‘å¸ƒ" > current_changelog.md
          echo "æ™ºèƒ½å·¥ç¨‹é‡è®¡ç®—ç³»ç»Ÿ ${{ steps.version.outputs.version }} æ­£å¼å‘å¸ƒï¼" >> current_changelog.md
          echo "" >> current_changelog.md
          echo "#### ä¸»è¦ç‰¹æ€§" >> current_changelog.md
          echo "- ğŸ¯ æ™ºèƒ½å›¾çº¸è¯†åˆ«ä¸AIåˆ†æ" >> current_changelog.md
          echo "- ğŸ“Š ç²¾ç¡®å·¥ç¨‹é‡è‡ªåŠ¨è®¡ç®—" >> current_changelog.md
          echo "- ğŸ—ï¸ å®Œæ•´é¡¹ç›®ç®¡ç†åŠŸèƒ½" >> current_changelog.md
          echo "- ğŸ“± ç°ä»£åŒ–å“åº”å¼ç•Œé¢" >> current_changelog.md
          echo "" >> current_changelog.md
          echo "#### æŠ€æœ¯æ¶æ„" >> current_changelog.md
          echo "- **åç«¯**: FastAPI + SQLAlchemy + PostgreSQL" >> current_changelog.md
          echo "- **å‰ç«¯**: React + TypeScript + Ant Design" >> current_changelog.md
          echo "- **AI**: OpenAI GPT + è‡ªå®šä¹‰è¯†åˆ«æ¨¡å‹" >> current_changelog.md
          echo "" >> current_changelog.md
          echo "æ›´å¤šè¯¦ç»†ä¿¡æ¯è¯·å‚é˜… [CHANGELOG.md](https://github.com/hongsir457/smart-qto-system/blob/master/CHANGELOG.md)" >> current_changelog.md
        fi

    - name: ğŸ·ï¸ åˆ›å»ºRelease
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.version }}
        release_name: æ™ºèƒ½å·¥ç¨‹é‡è®¡ç®—ç³»ç»Ÿ ${{ steps.version.outputs.version }}
        body_path: current_changelog.md
        draft: false
        prerelease: false

    - name: ğŸ“¦ ç”Ÿæˆé¡¹ç›®å½’æ¡£
      run: |
        # åˆ›å»ºæºç å½’æ¡£
        git archive --format=zip --output=smart-qto-system-${{ steps.version.outputs.version_without_v }}-source.zip HEAD
        
        # åˆ›å»ºå‘å¸ƒè¯´æ˜æ–‡ä»¶
        cat > release-info.md << EOF
        # æ™ºèƒ½å·¥ç¨‹é‡è®¡ç®—ç³»ç»Ÿ ${{ steps.version.outputs.version }}
        
        ## ğŸ“¥ ä¸‹è½½è¯´æ˜
        
        ### æºç åŒ…
        - **smart-qto-system-${{ steps.version.outputs.version_without_v }}-source.zip**: å®Œæ•´æºç åŒ…
        
        ### å¿«é€Ÿå¼€å§‹
        1. ä¸‹è½½æºç åŒ…å¹¶è§£å‹
        2. å‚ç…§ README.md é…ç½®å¼€å‘ç¯å¢ƒ
        3. æŒ‰ç…§å¿«é€Ÿå¼€å§‹æŒ‡å—å¯åŠ¨é¡¹ç›®
        
        ### ç³»ç»Ÿè¦æ±‚
        - Python 3.8+
        - Node.js 16+
        - PostgreSQL 12+
        - Redis 6+
        
        ### æŠ€æœ¯æ”¯æŒ
        - ğŸ“– [é¡¹ç›®æ–‡æ¡£](https://github.com/hongsir457/smart-qto-system)
        - ğŸ› [é—®é¢˜åé¦ˆ](https://github.com/hongsir457/smart-qto-system/issues)
        - ğŸ’¬ [è®¨è®ºç¤¾åŒº](https://github.com/hongsir457/smart-qto-system/discussions)
        
        ---
        
        **å‘å¸ƒæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')  
        **å‘å¸ƒåˆ†æ”¯**: master  
        **æäº¤å“ˆå¸Œ**: $GITHUB_SHA
        EOF

    - name: ğŸ“Š ç”Ÿæˆå‘å¸ƒç»Ÿè®¡
      run: |
        echo "## ğŸ“Š é¡¹ç›®ç»Ÿè®¡" >> release-info.md
        echo "" >> release-info.md
        echo "- **ä»£ç è¡Œæ•°**: $(find . -name '*.py' -o -name '*.ts' -o -name '*.tsx' -o -name '*.js' -o -name '*.jsx' | xargs wc -l | tail -1 | awk '{print $1}')" >> release-info.md
        echo "- **æäº¤æ¬¡æ•°**: $(git rev-list --count HEAD)" >> release-info.md
        echo "- **æ–‡ä»¶æ€»æ•°**: $(find . -type f | wc -l)" >> release-info.md
        echo "- **æœ€åæ›´æ–°**: $(git log -1 --format='%cd' --date=short)" >> release-info.md

  notify-release:
    name: ğŸ“¢ å‘å¸ƒé€šçŸ¥
    needs: create-release
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ“§ å‘é€é‚®ä»¶é€šçŸ¥ (å¯é€‰)
      run: |
        echo "Release ${{ github.ref }} has been created successfully!"
        echo "æ‚¨å¯ä»¥åœ¨é¡¹ç›®çš„Actionsä¸­é…ç½®é‚®ä»¶é€šçŸ¥æœåŠ¡"
        
    - name: ğŸ’¬ åˆ›å»ºå‘å¸ƒè®¨è®º (å¯é€‰)
      run: |
        echo "å¯ä»¥ä½¿ç”¨GitHub CLIæˆ–APIè‡ªåŠ¨åˆ›å»ºDiscussions"
        echo "è®©ç¤¾åŒºç”¨æˆ·äº†è§£æ–°ç‰ˆæœ¬å‘å¸ƒ" 